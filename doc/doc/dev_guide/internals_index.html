

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Internals &mdash; Tarantool Dev Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Build and contribute" href="build_contribute_index.html" />
    <link rel="prev" title="Module txn" href="reference_capi/txn.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Tarantool Dev Docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">Contributor’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../internals/source/index.html">Tarantool internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../internals/source/index.html#indices-and-tables">Indices and tables</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Tarantool Dev Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Contributor’s Guide</a> &raquo;</li>
        
      <li>Internals</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/doc/doc/dev_guide/internals_index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="internals">
<h1>Internals<a class="headerlink" href="#internals" title="Permalink to this headline">¶</a></h1>
<div class="section" id="tarantool-s-binary-protocol">
<span id="box-protocol-iproto-protocol"></span><h2>Tarantool’s binary protocol<a class="headerlink" href="#tarantool-s-binary-protocol" title="Permalink to this headline">¶</a></h2>
<p>Tarantool’s binary protocol is a binary request/response protocol.</p>
<div class="section" id="notation-in-diagrams">
<h3>Notation in diagrams<a class="headerlink" href="#notation-in-diagrams" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0    X
+----+
|    | - X + 1 bytes
+----+
 TYPE - type of MsgPack value (if it is a MsgPack object)

+====+
|    | - Variable size MsgPack object
+====+
 TYPE - type of MsgPack value

+~~~~+
|    | - Variable size MsgPack Array/Map
+~~~~+
 TYPE - type of MsgPack value
</pre></div>
</div>
<p>MsgPack data types:</p>
<ul class="simple">
<li><strong>MP_INT</strong> - Integer</li>
<li><strong>MP_MAP</strong> - Map</li>
<li><strong>MP_ARR</strong> - Array</li>
<li><strong>MP_STRING</strong> - String</li>
<li><strong>MP_FIXSTR</strong> - Fixed size string</li>
<li><strong>MP_OBJECT</strong> - Any MsgPack object</li>
<li><strong>MP_BIN</strong> - MsgPack binary format</li>
</ul>
</div>
<div class="section" id="greeting-packet">
<h3>Greeting packet<a class="headerlink" href="#greeting-packet" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TARANTOOL&#39;S GREETING:

0                                     63
+--------------------------------------+
|                                      |
| Tarantool Greeting (server version)  |
|               64 bytes               |
+---------------------+----------------+
|                     |                |
| BASE64 encoded SALT |      NULL      |
|      44 bytes       |                |
+---------------------+----------------+
64                  107              127
</pre></div>
</div>
<p>The server instance begins the dialogue by sending a fixed-size (128-byte) text greeting
to the client. The greeting always contains two 64-byte lines of ASCII text, each
line ending with a newline character (<code class="code docutils literal notranslate"><span class="pre">\n</span></code>). The first line contains the instance
version and protocol type. The second line contains up to 44 bytes of base64-encoded
random string, to use in the authentication packet, and ends with up to 23 spaces.</p>
</div>
<div class="section" id="unified-packet-structure">
<h3>Unified packet structure<a class="headerlink" href="#unified-packet-structure" title="Permalink to this headline">¶</a></h3>
<p>Once a greeting is read, the protocol becomes pure request/response and features
a complete access to Tarantool functionality, including:</p>
<ul class="simple">
<li>request multiplexing, e.g. ability to asynchronously issue multiple requests
via the same connection</li>
<li>response format that supports zero-copy writes</li>
</ul>
<p>The protocol uses <a class="reference external" href="http://msgpack.org">msgpack</a> for data structures
and encoding.</p>
<p>The protocol uses maps that contain some integer constants as keys.
These constants are defined in <a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.9/src/box/iproto_constants.h">src/box/iproto_constants.h</a>.
We list common constants here:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>-- user keys
&lt;iproto_sync&gt;          ::= 0x01
&lt;iproto_schema_id&gt;     ::= 0x05  /* also known as schema_version */
&lt;iproto_space_id&gt;      ::= 0x10
&lt;iproto_index_id&gt;      ::= 0x11
&lt;iproto_limit&gt;         ::= 0x12
&lt;iproto_offset&gt;        ::= 0x13
&lt;iproto_iterator&gt;      ::= 0x14
&lt;iproto_key&gt;           ::= 0x20
&lt;iproto_tuple&gt;         ::= 0x21
&lt;iproto_function_name&gt; ::= 0x22
&lt;iproto_username&gt;      ::= 0x23
&lt;iproto_expr&gt;          ::= 0x27 /* also known as expression */
&lt;iproto_ops&gt;           ::= 0x28
&lt;iproto_data&gt;          ::= 0x30
&lt;iproto_error&gt;         ::= 0x31
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>-- -- Value for &lt;code&gt; key in request can be:
-- User command codes
&lt;iproto_select&gt;       ::= 0x01
&lt;iproto_insert&gt;       ::= 0x02
&lt;iproto_replace&gt;      ::= 0x03
&lt;iproto_update&gt;       ::= 0x04
&lt;iproto_delete&gt;       ::= 0x05
&lt;iproto_call_16&gt;      ::= 0x06 /* as used in version 1.6 */
&lt;iproto_auth&gt;         ::= 0x07
&lt;iproto_eval&gt;         ::= 0x08
&lt;iproto_upsert&gt;       ::= 0x09
&lt;iproto_call&gt;         ::= 0x0a
-- Admin command codes
-- (including codes for replica-set initialization and master election)
&lt;iproto_ping&gt;         ::= 0x40
&lt;iproto_join&gt;         ::= 0x41 /* i.e. replication join */
&lt;iproto_subscribe&gt;    ::= 0x42
&lt;iproto_request_vote&gt; ::= 0x43

-- -- Value for &lt;code&gt; key in response can be:
&lt;iproto_ok&gt;           ::= 0x00
&lt;iproto_type_error&gt;   ::= 0x8XXX /* where XXX is a value in errcode.h */
</pre></div>
</div>
<p>Both <code class="code docutils literal notranslate"><span class="pre">&lt;header&gt;</span></code> and <code class="code docutils literal notranslate"><span class="pre">&lt;body&gt;</span></code> are msgpack maps:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Request/Response:

0        5
+--------+ +============+ +===================================+
| BODY + | |            | |                                   |
| HEADER | |   HEADER   | |               BODY                |
|  SIZE  | |            | |                                   |
+--------+ +============+ +===================================+
  MP_INT       MP_MAP                     MP_MAP
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>UNIFIED HEADER:

+================+================+=====================+
|                |                |                     |
|   0x00: CODE   |   0x01: SYNC   |    0x05: SCHEMA_ID  |
| MP_INT: MP_INT | MP_INT: MP_INT |  MP_INT: MP_INT     |
|                |                |                     |
+================+================+=====================+
                          MP_MAP
</pre></div>
</div>
<p>They only differ in the allowed set of keys and values. The key defines the type
of value that follows. In a request, the body map can be absent. Responses will
contain it anyway even if it is a <code class="docutils literal notranslate"><span class="pre">PING</span></code>. <code class="docutils literal notranslate"><span class="pre">schema_id</span></code>
may be absent in the request’s header, meaning that there will be no version
checking, but it must be present in the response. If <code class="docutils literal notranslate"><span class="pre">schema_id</span></code> is sent in
the header, then it will be checked.</p>
</div>
<div class="section" id="authentication">
<span id="box-protocol-authentication"></span><h3>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h3>
<p>When a client connects to the server instance, the instance responds with a 128-byte
text greeting message. Part of the greeting is base-64 encoded session salt -
a random string which can be used for authentication. The length of decoded
salt (44 bytes) exceeds the amount necessary to sign the authentication
message (first 20 bytes). An excess is reserved for future authentication
schemas.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>PREPARE SCRAMBLE:

    LEN(ENCODED_SALT) = 44;
    LEN(SCRAMBLE)     = 20;

prepare &#39;chap-sha1&#39; scramble:

    salt = base64_decode(encoded_salt);
    step_1 = sha1(password);
    step_2 = sha1(step_1);
    step_3 = sha1(salt, step_2);
    scramble = xor(step_1, step_3);
    return scramble;

AUTHORIZATION BODY: CODE = 0x07

+==================+====================================+
|                  |        +-------------+-----------+ |
|  (KEY)           | (TUPLE)|  len == 9   | len == 20 | |
|   0x23:USERNAME  |   0x21:| &quot;chap-sha1&quot; |  SCRAMBLE | |
| MP_INT:MP_STRING | MP_INT:|  MP_STRING  |  MP_BIN   | |
|                  |        +-------------+-----------+ |
|                  |                   MP_ARRAY         |
+==================+====================================+
                        MP_MAP
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">&lt;key&gt;</span></code> holds the user name. <code class="code docutils literal notranslate"><span class="pre">&lt;tuple&gt;</span></code> must be an array of 2 fields:
authentication mechanism (“chap-sha1” is the only supported mechanism right now)
and password, encrypted according to the specified mechanism. Authentication in
Tarantool is optional, if no authentication is performed, session user is ‘guest’.
The instance responds to authentication packet with a standard response with 0 tuples.</p>
</div>
<div class="section" id="requests">
<h3>Requests<a class="headerlink" href="#requests" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>SELECT: CODE - 0x01
Find tuples matching the search pattern</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SELECT BODY:

+==================+==================+==================+
|                  |                  |                  |
|   0x10: SPACE_ID |   0x11: INDEX_ID |   0x12: LIMIT    |
| MP_INT: MP_INT   | MP_INT: MP_INT   | MP_INT: MP_INT   |
|                  |                  |                  |
+==================+==================+==================+
|                  |                  |                  |
|   0x13: OFFSET   |   0x14: ITERATOR |   0x20: KEY      |
| MP_INT: MP_INT   | MP_INT: MP_INT   | MP_INT: MP_ARRAY |
|                  |                  |                  |
+==================+==================+==================+
                          MP_MAP
</pre></div>
</div>
<ul class="simple">
<li>INSERT:  CODE - 0x02
Inserts tuple into the space, if no tuple with same unique keys exists. Otherwise throw <em>duplicate key</em> error.</li>
<li>REPLACE: CODE - 0x03
Insert a tuple into the space or replace an existing one.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>INSERT/REPLACE BODY:

+==================+==================+
|                  |                  |
|   0x10: SPACE_ID |   0x21: TUPLE    |
| MP_INT: MP_INT   | MP_INT: MP_ARRAY |
|                  |                  |
+==================+==================+
                 MP_MAP
</pre></div>
</div>
<ul class="simple">
<li>UPDATE: CODE - 0x04
Update a tuple</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>UPDATE BODY:

+==================+=======================+
|                  |                       |
|   0x10: SPACE_ID |   0x11: INDEX_ID      |
| MP_INT: MP_INT   | MP_INT: MP_INT        |
|                  |                       |
+==================+=======================+
|                  |          +~~~~~~~~~~+ |
|                  |          |          | |
|                  | (TUPLE)  |    OP    | |
|   0x20: KEY      |    0x21: |          | |
| MP_INT: MP_ARRAY |  MP_INT: +~~~~~~~~~~+ |
|                  |            MP_ARRAY   |
+==================+=======================+
                 MP_MAP
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>OP:
    Works only for integer fields:
    * Addition    OP = &#39;+&#39; . space[key][field_no] += argument
    * Subtraction OP = &#39;-&#39; . space[key][field_no] -= argument
    * Bitwise AND OP = &#39;&amp;&#39; . space[key][field_no] &amp;= argument
    * Bitwise XOR OP = &#39;^&#39; . space[key][field_no] ^= argument
    * Bitwise OR  OP = &#39;|&#39; . space[key][field_no] |= argument
    Works on any fields:
    * Delete      OP = &#39;#&#39;
      delete &lt;argument&gt; fields starting
      from &lt;field_no&gt; in the space[&lt;key&gt;]

0           2
+-----------+==========+==========+
|           |          |          |
|    OP     | FIELD_NO | ARGUMENT |
| MP_FIXSTR |  MP_INT  |  MP_INT  |
|           |          |          |
+-----------+==========+==========+
              MP_ARRAY
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    * Insert      OP = &#39;!&#39;
      insert &lt;argument&gt; before &lt;field_no&gt;
    * Assign      OP = &#39;=&#39;
      assign &lt;argument&gt; to field &lt;field_no&gt;.
      will extend the tuple if &lt;field_no&gt; == &lt;max_field_no&gt; + 1

0           2
+-----------+==========+===========+
|           |          |           |
|    OP     | FIELD_NO | ARGUMENT  |
| MP_FIXSTR |  MP_INT  | MP_OBJECT |
|           |          |           |
+-----------+==========+===========+
              MP_ARRAY

    Works on string fields:
    * Splice      OP = &#39;:&#39;
      take the string from space[key][field_no] and
      substitute &lt;offset&gt; bytes from &lt;position&gt; with &lt;argument&gt;
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0           2
+-----------+==========+==========+========+==========+
|           |          |          |        |          |
|    &#39;:&#39;    | FIELD_NO | POSITION | OFFSET | ARGUMENT |
| MP_FIXSTR |  MP_INT  |  MP_INT  | MP_INT |  MP_STR  |
|           |          |          |        |          |
+-----------+==========+==========+========+==========+
                         MP_ARRAY
</pre></div>
</div>
<p>It is an error to specify an argument of a type that differs from the expected type.</p>
<ul class="simple">
<li>DELETE: CODE - 0x05
Delete a tuple</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DELETE BODY:

+==================+==================+==================+
|                  |                  |                  |
|   0x10: SPACE_ID |   0x11: INDEX_ID |   0x20: KEY      |
| MP_INT: MP_INT   | MP_INT: MP_INT   | MP_INT: MP_ARRAY |
|                  |                  |                  |
+==================+==================+==================+
                          MP_MAP
</pre></div>
</div>
<ul class="simple">
<li>CALL_16: CODE - 0x06
Call a stored function, returning an array of tuples. This is deprecated; CALL (0x0a) is recommended instead.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CALL_16 BODY:

+=======================+==================+
|                       |                  |
|   0x22: FUNCTION_NAME |   0x21: TUPLE    |
| MP_INT: MP_STRING     | MP_INT: MP_ARRAY |
|                       |                  |
+=======================+==================+
                    MP_MAP
</pre></div>
</div>
<ul class="simple" id="box-protocol-eval">
<li>EVAL: CODE - 0x08
Evaulate Lua expression</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>EVAL BODY:

+=======================+==================+
|                       |                  |
|   0x27: EXPRESSION    |   0x21: TUPLE    |
| MP_INT: MP_STRING     | MP_INT: MP_ARRAY |
|                       |                  |
+=======================+==================+
                    MP_MAP
</pre></div>
</div>
<ul class="simple">
<li>UPSERT: CODE - 0x09
Update tuple if it would be found elsewhere try to insert tuple. Always use primary index for key.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>UPSERT BODY:

+==================+==================+==========================+
|                  |                  |             +~~~~~~~~~~+ |
|                  |                  |             |          | |
|   0x10: SPACE_ID |   0x21: TUPLE    |       (OPS) |    OP    | |
| MP_INT: MP_INT   | MP_INT: MP_ARRAY |       0x28: |          | |
|                  |                  |     MP_INT: +~~~~~~~~~~+ |
|                  |                  |               MP_ARRAY   |
+==================+==================+==========================+
                                MP_MAP

Operations structure same as for UPDATE operation.
   0           2
+-----------+==========+==========+
|           |          |          |
|    OP     | FIELD_NO | ARGUMENT |
| MP_FIXSTR |  MP_INT  |  MP_INT  |
|           |          |          |
+-----------+==========+==========+
              MP_ARRAY

Supported operations:

&#39;+&#39; - add a value to a numeric field. If the filed is not numeric, it&#39;s
      changed to 0 first. If the field does not exist, the operation is
      skipped. There is no error in case of overflow either, the value
      simply wraps around in C style. The range of the integer is MsgPack:
      from -2^63 to 2^64-1
&#39;-&#39; - same as the previous, but subtract a value
&#39;=&#39; - assign a field to a value. The field must exist, if it does not exist,
      the operation is skipped.
&#39;!&#39; - insert a field. It&#39;s only possible to insert a field if this create no
      nil &quot;gaps&quot; between fields. E.g. it&#39;s possible to add a field between
      existing fields or as the last field of the tuple.
&#39;#&#39; - delete a field. If the field does not exist, the operation is skipped.
      It&#39;s not possible to change with update operations a part of the primary
      key (this is validated before performing upsert).
</pre></div>
</div>
<ul class="simple">
<li>CALL: CODE - 0x0a
Similar to CALL_16, but – like EVAL, CALL returns a list of values, unconverted</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CALL BODY:

+=======================+==================+
|                       |                  |
|   0x22: FUNCTION_NAME |   0x21: TUPLE    |
| MP_INT: MP_STRING     | MP_INT: MP_ARRAY |
|                       |                  |
+=======================+==================+
                    MP_MAP
</pre></div>
</div>
</div>
<div class="section" id="response-packet-structure">
<h3>Response packet structure<a class="headerlink" href="#response-packet-structure" title="Permalink to this headline">¶</a></h3>
<p>We will show whole packets here:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>OK:    LEN + HEADER + BODY

0      5                                          OPTIONAL
+------++================+================++===================+
|      ||                |                ||                   |
| BODY ||   0x00: 0x00   |   0x01: SYNC   ||   0x30: DATA      |
|HEADER|| MP_INT: MP_INT | MP_INT: MP_INT || MP_INT: MP_OBJECT |
| SIZE ||                |                ||                   |
+------++================+================++===================+
 MP_INT                MP_MAP                      MP_MAP
</pre></div>
</div>
<p>Set of tuples in the response <code class="code docutils literal notranslate"><span class="pre">&lt;data&gt;</span></code> expects a msgpack array of tuples as value
EVAL command returns arbitrary <cite>MP_ARRAY</cite> with arbitrary MsgPack values.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ERROR: LEN + HEADER + BODY

0      5
+------++================+================++===================+
|      ||                |                ||                   |
| BODY ||   0x00: 0x8XXX |   0x01: SYNC   ||   0x31: ERROR     |
|HEADER|| MP_INT: MP_INT | MP_INT: MP_INT || MP_INT: MP_STRING |
| SIZE ||                |                ||                   |
+------++================+================++===================+
 MP_INT                MP_MAP                      MP_MAP

Where 0xXXX is ERRCODE.
</pre></div>
</div>
<p>An error message is present in the response only if there is an error; <code class="code docutils literal notranslate"><span class="pre">&lt;error&gt;</span></code>
expects as value a msgpack string.</p>
<p>Convenience macros which define hexadecimal constants for return codes
can be found in <a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.10/src/box/errcode.h">src/box/errcode.h</a></p>
</div>
<div class="section" id="replication-packet-structure">
<h3>Replication packet structure<a class="headerlink" href="#replication-packet-structure" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>-- replication keys
&lt;server_id&gt;     ::= 0x02
&lt;lsn&gt;           ::= 0x03
&lt;timestamp&gt;     ::= 0x04
&lt;server_uuid&gt;   ::= 0x24
&lt;cluster_uuid&gt;  ::= 0x25
&lt;vclock&gt;        ::= 0x26
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>-- replication codes
&lt;join&gt;      ::= 0x41
&lt;subscribe&gt; ::= 0x42
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>JOIN:

In the beginning you must send initial JOIN
               HEADER                      BODY
+================+================++===================+
|                |                ||   SERVER_UUID     |
|   0x00: 0x41   |   0x01: SYNC   ||   0x24: UUID      |
| MP_INT: MP_INT | MP_INT: MP_INT || MP_INT: MP_STRING |
|                |                ||                   |
+================+================++===================+
               MP_MAP                     MP_MAP

Then instance, which we connect to, will send last SNAP file by, simply,
creating a number of INSERTs (with additional LSN and ServerID)
(don&#39;t reply). Then it&#39;ll send a vclock&#39;s MP_MAP and close a socket.

+================+================++============================+
|                |                ||        +~~~~~~~~~~~~~~~~~+ |
|                |                ||        |                 | |
|   0x00: 0x00   |   0x01: SYNC   ||   0x26:| SRV_ID: SRV_LSN | |
| MP_INT: MP_INT | MP_INT: MP_INT || MP_INT:| MP_INT: MP_INT  | |
|                |                ||        +~~~~~~~~~~~~~~~~~+ |
|                |                ||               MP_MAP       |
+================+================++============================+
               MP_MAP                      MP_MAP

SUBSCRIBE:

Then you must send SUBSCRIBE:

                              HEADER
+===================+===================+
|                   |                   |
|     0x00: 0x42    |    0x01: SYNC     |
|   MP_INT: MP_INT  |  MP_INT: MP_INT   |
|                   |                   |
+===================+===================+
|    SERVER_UUID    |    CLUSTER_UUID   |
|   0x24: UUID      |   0x25: UUID      |
| MP_INT: MP_STRING | MP_INT: MP_STRING |
|                   |                   |
+===================+===================+
                 MP_MAP

      BODY
+================+
|                |
|   0x26: VCLOCK |
| MP_INT: MP_INT |
|                |
+================+
      MP_MAP

Then you must process every query that&#39;ll came through other masters.
Every request between masters will have Additional LSN and SERVER_ID.
</pre></div>
</div>
</div>
<div class="section" id="xlog-snap">
<h3>XLOG / SNAP<a class="headerlink" href="#xlog-snap" title="Permalink to this headline">¶</a></h3>
<p>XLOG and SNAP files have nearly the same format. The header looks like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;type&gt;\n                  SNAP\n or XLOG\n
&lt;version&gt;\n               currently 0.13\n
Server: &lt;server_uuid&gt;\n   where UUID is a 36-byte string
VClock: &lt;vclock_map&gt;\n    e.g. {1: 0}\n
\n
</pre></div>
</div>
<p>After the file header come the data tuples.
Tuples begin with a row marker <code class="docutils literal notranslate"><span class="pre">0xd5ba0bab</span></code> and
the last tuple may be followed by an EOF marker
<code class="docutils literal notranslate"><span class="pre">0xd510aded</span></code>.
Thus, between the file header and the EOF marker, there
may be data tuples that have this form:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0            3 4                                         17
+-------------+========+============+===========+=========+
|             |        |            |           |         |
| 0xd5ba0bab  | LENGTH | CRC32 PREV | CRC32 CUR | PADDING |
|             |        |            |           |         |
+-------------+========+============+===========+=========+
  MP_FIXEXT2    MP_INT     MP_INT       MP_INT      ---

+============+ +===================================+
|            | |                                   |
|   HEADER   | |                BODY               |
|            | |                                   |
+============+ +===================================+
    MP_MAP                     MP_MAP
</pre></div>
</div>
<p>See the example in the following section.</p>
</div>
</div>
<div class="section" id="data-persistence-and-the-wal-file-format">
<span id="internals-wal"></span><span id="internals-data-persistence"></span><span id="id1"></span><h2>Data persistence and the WAL file format<a class="headerlink" href="#data-persistence-and-the-wal-file-format" title="Permalink to this headline">¶</a></h2>
<p>To maintain data persistence, Tarantool writes each data change request (insert,
update, delete, replace, upsert) into a write-ahead log (WAL) file in the
<a class="reference internal" href="../reference/configuration/index.html#cfg-basic-wal-dir"><span class="std std-ref">wal_dir</span></a> directory. A new WAL file is created for every
<a class="reference internal" href="../reference/configuration/index.html#cfg-binary-logging-snapshots-rows-per-wal"><span class="std std-ref">rows_per_wal</span></a> records, or for every
<a class="reference internal" href="../reference/configuration/index.html#cfg-binary-logging-snapshots-wal-max-size"><span class="std std-ref">wal_max_size</span></a> bytes.
Each data change request gets assigned a continuously growing 64-bit log sequence
number. The name of the WAL file is based on the log sequence number of the first
record in the file, plus an extension <code class="docutils literal notranslate"><span class="pre">.xlog</span></code>.</p>
<p>Apart from a log sequence number and the data change request (formatted as in
<a class="reference internal" href="#box-protocol-iproto-protocol"><span class="std std-ref">Tarantool’s binary protocol</span></a>),
each WAL record contains a header, some metadata, and then the data formatted
according to <a class="reference external" href="https://en.wikipedia.org/wiki/MessagePack">msgpack</a> rules.
For example, this is what the WAL file looks like after the first INSERT request
(“s:insert({1})”) for the sandbox database created in our
<a class="reference internal" href="../getting_started/index.html#getting-started"><span class="std std-ref">“Getting started” exercises</span></a>.
On the left are the hexadecimal bytes that you would see with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> hexdump <span class="m">00000000000000000000</span>.xlog
</pre></div>
</div>
<p>and on the right are comments.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Hex dump of WAL file       Comment
--------------------       -------
58 4c 4f 47 0a             &quot;XLOG\n&quot;
30 2e 31 33 0a             &quot;0.13\n&quot; = version
53 65 72 76 65 72 3a 20    &quot;Server: &quot;
38 62 66 32 32 33 65 30 2d [Server UUID]\n
36 39 31 34 2d 34 62 35 35
2d 39 34 64 32 2d 64 32 62
36 64 30 39 62 30 31 39 36
0a
56 43 6c 6f 63 6b 3a 20    &quot;Vclock: &quot;
7b 7d                      &quot;{}&quot; = vclock value, initially blank
...                        (not shown = tuples for system spaces)
d5 ba 0b ab                Magic row marker always = 0xab0bbad5
19                         Length, not including length of header, = 25 bytes
00                           Record header: previous crc32
ce 8c 3e d6 70               Record header: current crc32
a7 cc 73 7f 00 00 66 39      Record header: padding
84                         msgpack code meaning &quot;Map of 4 elements&quot; follows
00 02                         element#1: tag=request type, value=0x02=IPROTO_INSERT
02 01                         element#2: tag=server id, value=0x01
03 04                         element#3: tag=lsn, value=0x04
04 cb 41 d4 e2 2f 62 fd d5 d4 element#4: tag=timestamp, value=an 8-byte &quot;Float64&quot;
82                         msgpack code meaning &quot;map of 2 elements&quot; follows
10 cd 02 00                   element#1: tag=space id, value=512, big byte first
21 91 01                      element#2: tag=tuple, value=1-element fixed array={1}
</pre></div>
</div>
<p>A tool for reading .xlog files is Tarantool’s <a class="reference internal" href="../reference/reference_lua/xlog.html#xlog"><span class="std std-ref">xlog module</span></a>.</p>
<p>Tarantool processes requests atomically: a change is either accepted and recorded
in the WAL, or discarded completely. Let’s clarify how this happens, using the
REPLACE request as an example:</p>
<ol class="arabic simple">
<li>The server instance attempts to locate the original tuple by primary key. If found, a
reference to the tuple is retained for later use.</li>
<li>The new tuple is validated. If for example it does not contain an indexed
field, or it has an indexed field whose type does not match the type
according to the index definition, the change is aborted.</li>
<li>The new tuple replaces the old tuple in all existing indexes.</li>
<li>A message is sent to the writer process running in the WAL thread, requesting that
the change be recorded in the WAL. The instance switches to work on the next
request until the write is acknowledged.</li>
<li>On success, a confirmation is sent to the client. On failure, a rollback
procedure is begun. During the rollback procedure, the transaction processor
rolls back all changes to the database which occurred after the first failed
change, from latest to oldest, up to the first failed change. All rolled back
requests are aborted with <a href="#id3"><span class="problematic" id="id4">:errcode:`ER_WAL_IO &lt;ER_WAL_IO&gt;`</span></a> error. No new
change is applied while rollback is in progress. When the rollback procedure
is finished, the server restarts the processing pipeline.</li>
</ol>
<p>One advantage of the described algorithm is that complete request pipelining is
achieved, even for requests on the same value of the primary key. As a result,
database performance doesn’t degrade even if all requests refer to the same
key in the same space.</p>
<p>The transaction processor thread communicates with the WAL writer thread using
asynchronous (yet reliable) messaging; the transaction processor thread, not
being blocked on WAL tasks, continues to handle requests quickly even at high
volumes of disk I/O. A response to a request is sent as soon as it is ready,
even if there were earlier incomplete requests on the same connection. In
particular, SELECT performance, even for SELECTs running on a connection packed
with UPDATEs and DELETEs, remains unaffected by disk load.</p>
<p>The WAL writer employs a number of durability modes, as defined in configuration
variable <a class="reference internal" href="../reference/configuration/index.html#index-wal-mode"><span class="std std-ref">wal_mode</span></a>. It is possible to turn the write-ahead
log completely off, by setting
<a class="reference internal" href="../reference/configuration/index.html#cfg-binary-logging-snapshots-wal-mode"><span class="std std-ref">wal_mode</span></a> to <em>none</em>. Even
without the write-ahead log it’s still possible to take a persistent copy of the
entire data set with the <a class="reference internal" href="../reference/reference_lua/box_snapshot.html#box-snapshot"><span class="std std-ref">box.snapshot()</span></a> request.</p>
<p>An .xlog file always contains changes based on the primary key.
Even if the client requested an update or delete using
a secondary key, the record in the .xlog file will contain the primary key.</p>
</div>
<div class="section" id="the-snapshot-file-format">
<span id="internals-snapshot"></span><h2>The snapshot file format<a class="headerlink" href="#the-snapshot-file-format" title="Permalink to this headline">¶</a></h2>
<p>The format of a snapshot .snap file is nearly the same as the format of a WAL .xlog file.
However, the snapshot header differs: it contains the instance’s global unique identifier
and the snapshot file’s position in history, relative to earlier snapshot files.
Also, the content differs: an .xlog file may contain records for any data-change
requests (inserts, updates, upserts, and deletes), a .snap file may only contain records
of inserts to memtx spaces.</p>
<p>Primarily, the .snap file’s records are ordered by space id. Therefore the records of
system spaces – such as <code class="docutils literal notranslate"><span class="pre">_schema</span></code>, <code class="docutils literal notranslate"><span class="pre">_space</span></code>, <code class="docutils literal notranslate"><span class="pre">_index</span></code>, <code class="docutils literal notranslate"><span class="pre">_func</span></code>, <code class="docutils literal notranslate"><span class="pre">_priv</span></code>
and <code class="docutils literal notranslate"><span class="pre">_cluster</span></code> – will be at the start of the .snap file, before the records of
any spaces that were created by users.</p>
<p>Secondarily, the .snap file’s records are ordered by primary key within space id.</p>
</div>
<div class="section" id="the-recovery-process">
<span id="internals-recovery-process"></span><h2>The recovery process<a class="headerlink" href="#the-recovery-process" title="Permalink to this headline">¶</a></h2>
<p>The recovery process begins when box.cfg{} happens for the
first time after the Tarantool server instance starts.</p>
<p>The recovery process must recover the databases
as of the moment when the instance was last shut down. For this it may
use the latest snapshot file and any WAL files that were written
after the snapshot. One complicating factor is that Tarantool
has two engines – the memtx data must be reconstructed entirely
from the snapshot and the WAL files, while the vinyl data will
be on disk but might require updating around the time of a checkpoint.
(When a snapshot happens, Tarantool tells the vinyl engine to
make a checkpoint, and the snapshot operation is rolled back if
anything goes wrong, so vinyl’s checkpoint is at least as fresh
as the snapshot file.)</p>
<dl class="docutils">
<dt>Step 1</dt>
<dd>Read the configuration parameters in the <code class="docutils literal notranslate"><span class="pre">box.cfg{}</span></code> request.
Parameters which affect recovery may include <a class="reference internal" href="../reference/configuration/index.html#cfg-basic-work-dir"><span class="std std-ref">work_dir</span></a>,
<a class="reference internal" href="../reference/configuration/index.html#cfg-basic-wal-dir"><span class="std std-ref">wal_dir</span></a>, <a class="reference internal" href="../reference/configuration/index.html#cfg-basic-memtx-dir"><span class="std std-ref">memtx_dir</span></a>,
<a class="reference internal" href="../reference/configuration/index.html#cfg-basic-vinyl-dir"><span class="std std-ref">vinyl_dir</span></a>
and <a class="reference internal" href="../reference/configuration/index.html#cfg-binary-logging-snapshots-force-recovery"><span class="std std-ref">force_recovery</span></a>.</dd>
<dt>Step 2</dt>
<dd><p class="first">Find the latest snapshot file. Use its data to reconstruct the in-memory
databases. Instruct the vinyl engine to recover to the latest checkpoint.</p>
<p>There are actually two variations of the reconstruction procedure for memtx
databases, depending on whether the recovery process is “default”.</p>
<p>If the recovery process is default (<code class="docutils literal notranslate"><span class="pre">force_recovery</span></code> is <code class="docutils literal notranslate"><span class="pre">false</span></code>),
memtx can read data in the snapshot with all indexes disabled.
First, all tuples are read into memory. Then, primary keys are built in bulk,
taking advantage of the fact that the data is already sorted by primary key
within each space.</p>
<p class="last">If the recovery process is non-default (<code class="docutils literal notranslate"><span class="pre">force_recovery</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code>),
Tarantool performs additional checking. Indexes are enabled at
the start, and tuples are added one by one. This means that any unique-key
constraint violations will be caught, and any duplicates will be skipped.
Normally there will be no constraint violations or duplicates, so these checks
are only made if an error has occurred.</p>
</dd>
<dt>Step 3</dt>
<dd>Find the WAL file that was made at the time of, or after, the snapshot file.
Read its log entries until the log-entry LSN is greater than the LSN of the
snapshot, or greater than the LSN of the vinyl checkpoint. This is the
recovery process’s “start position”; it matches the current state of the
engines.</dd>
<dt>Step 4</dt>
<dd>Redo the log entries, from the start position to the end of the WAL. The
engine skips a redo instruction if it is older than the engine’s checkpoint.</dd>
<dt>Step 5</dt>
<dd>For the memtx engine, re-create all secondary indexes.</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="build_contribute_index.html" class="btn btn-neutral float-right" title="Build and contribute" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="reference_capi/txn.html" class="btn btn-neutral float-left" title="Module txn" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Tarantool Core Team

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>