

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Submodule box.session &mdash; Tarantool Dev Docs  documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home" alt="Documentation Home"> Tarantool Dev Docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../dev_guide/index.html">Contributor’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../internals/source/index.html">Tarantool internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../internals/source/index.html#indices-and-tables">Indices and tables</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Tarantool Dev Docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Submodule <cite>box.session</cite></li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../../_sources/doc/doc/reference/reference_lua/box_session.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="submodule-box-session">
<span id="box-session"></span><h1>Submodule <cite>box.session</cite><a class="headerlink" href="#submodule-box-session" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">box.session</span></code> submodule allows querying the session state, writing to a
session-specific temporary Lua table, or sending out-of-band messages, or
setting up triggers which will fire when a session starts or ends.</p>
<p>A <em>session</em> is an object associated with each client connection.</p>
</div>
<div class="section" id="index">
<h2>Index<a class="headerlink" href="#index" title="Permalink to this headline">¶</a></h2>
<p>Below is a list of all <code class="docutils literal notranslate"><span class="pre">box.session</span></code> functions and members.</p>
<div class="table docutils container">
<table border="1" class="left-align-column-1 left-align-column-2 docutils">
<colgroup>
<col width="54%" />
<col width="46%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Use</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><a class="reference internal" href="#box-session-id"><span class="std std-ref">box.session.id()</span></a></td>
<td>Get the current session’s ID</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-session-exists"><span class="std std-ref">box.session.exists()</span></a></td>
<td>Check if a session exists</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-session-peer"><span class="std std-ref">box.session.peer()</span></a></td>
<td>Get the session peer’s host
address and port</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-session-sync"><span class="std std-ref">box.session.sync()</span></a></td>
<td>Get the sync integer constant</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-session-user"><span class="std std-ref">box.session.user()</span></a></td>
<td>Get the current user’s name</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-session-type"><span class="std std-ref">box.session.type()</span></a></td>
<td>Get the connection type or
cause of action</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-session-su"><span class="std std-ref">box.session.su()</span></a></td>
<td>Change the current user</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-session-uid"><span class="std std-ref">box.session.uid()</span></a></td>
<td>Get the current user’s ID</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-session-euid"><span class="std std-ref">box.session.euid()</span></a></td>
<td>Get the current effective
user’s ID</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-session-storage"><span class="std std-ref">box.session.storage</span></a></td>
<td>Table with session-specific
names and values</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-session-on-connect"><span class="std std-ref">box.session.on_connect()</span></a></td>
<td>Define a connect trigger</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-session-on-disconnect"><span class="std std-ref">box.session.on_disconnect()</span></a></td>
<td>Define a disconnect trigger</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-session-on-auth"><span class="std std-ref">box.session.on_auth()</span></a></td>
<td>Define an authentication
trigger</td>
</tr>
<tr class="row-odd"><td><a class="reference internal" href="#box-session-on-access-denied"><span class="std std-ref">box.session.on_access_denied()</span></a></td>
<td>Define a trigger to report
restricted actions</td>
</tr>
<tr class="row-even"><td><a class="reference internal" href="#box-session-push"><span class="std std-ref">box.session.push()</span></a></td>
<td>Send an out-of-band message</td>
</tr>
</tbody>
</table>
</div>
<span class="target" id="module-box.session"></span><span class="target" id="box-session-id"></span><dl class="function">
<dt id="box.session.id">
<code class="descclassname">box.session.</code><code class="descname">id</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#box.session.id" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">the unique identifier (ID) for the current session.
The result can be 0 or -1 meaning there is no session.</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">number</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="box-session-exists"></span><dl class="function">
<dt id="box.session.exists">
<code class="descclassname">box.session.</code><code class="descname">exists</code><span class="sig-paren">(</span><em>id</em><span class="sig-paren">)</span><a class="headerlink" href="#box.session.exists" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">true if the session exists, false if the session does not exist.</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">boolean</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="box-session-peer"></span><dl class="function">
<dt id="box.session.peer">
<code class="descclassname">box.session.</code><code class="descname">peer</code><span class="sig-paren">(</span><em>id</em><span class="sig-paren">)</span><a class="headerlink" href="#box.session.peer" title="Permalink to this definition">¶</a></dt>
<dd><p>This function works only if there is a peer, that is,
if a connection has been made to a separate Tarantool instance.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">The host address and port of the session peer,
for example “127.0.0.1:55457”.
If the session exists but there is no connection to a
separate instance, the return is null.
The command is executed on the server instance,
so the “local name” is the server instance’s host
and port, and the “peer name” is the client’s host
and port.</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">string</td>
</tr>
</tbody>
</table>
<p>Possible errors: ‘session.peer(): session does not exist’</p>
</dd></dl>

<span class="target" id="box-session-sync"></span><dl class="function">
<dt id="box.session.sync">
<code class="descclassname">box.session.</code><code class="descname">sync</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#box.session.sync" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">the value of the <code class="code docutils literal notranslate"><span class="pre">sync</span></code> integer constant used in the
<a class="reference external" href="https://github.com/tarantool/tarantool/blob/1.10/src/box/iproto_constants.h">binary protocol</a>.
This value becomes invalid when the session is disconnected.</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">number</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="box-session-user"></span><dl class="function">
<dt id="box.session.user">
<code class="descclassname">box.session.</code><code class="descname">user</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#box.session.user" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">the name of the <a class="reference internal" href="../../book/box/authentication_index.html#authentication-users"><span class="std std-ref">current user</span></a></td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">string</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="box-session-type"></span><dl class="function">
<dt id="box.session.type">
<code class="descclassname">box.session.</code><code class="descname">type</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#box.session.type" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">the type of connection or cause of action.</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">string</td>
</tr>
</tbody>
</table>
<p>Possible return values are:</p>
<ul class="simple">
<li>‘binary’ if the connection was done via the binary protocol, for example
to a target made with
<a class="reference internal" href="../configuration/index.html#cfg-basic-listen"><span class="std std-ref">box.cfg{listen=…}</span></a>;</li>
<li>‘console’ if the connection was done via the administrative console,
for example to a target made with
<a class="reference internal" href="console.html#console-listen"><span class="std std-ref">console.listen</span></a>;</li>
<li>‘repl’ if the connection was done directly, for example when
<a class="reference internal" href="../../book/admin/server_introspection.html#admin-using-tarantool-as-a-client"><span class="std std-ref">using Tarantool as a client</span></a>;</li>
<li>‘applier’ if the action is due to
<a class="reference internal" href="../../book/replication/index.html#replication"><span class="std std-ref">replication</span></a>,
regardless of how the connection was done;</li>
<li>‘background’ if the action is in a
<a class="reference internal" href="fiber.html#fiber-module"><span class="std std-ref">background fiber</span></a>,
regardless of whether the Tarantool server was
<a class="reference internal" href="../configuration/index.html#cfg-basic-background"><span class="std std-ref">started in the background</span></a>.</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">box.session.type()</span></code> is useful for an
<a class="reference internal" href="box_space_index.html#box-space-on-replace"><span class="std std-ref">on_replace()</span></a> trigger
on a replica – the value will be ‘applier’ if and only if
the trigger was activated because of a request that was done on
the master.</p>
</dd></dl>

<span class="target" id="box-session-su"></span><dl class="function">
<dt id="box.session.su">
<code class="descclassname">box.session.</code><code class="descname">su</code><span class="sig-paren">(</span><em>user-name</em><span class="optional">[</span>, <em>function-to-execute</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#box.session.su" title="Permalink to this definition">¶</a></dt>
<dd><p>Change Tarantool’s <a class="reference internal" href="../../book/box/authentication_index.html#authentication-users"><span class="std std-ref">current user</span></a> –
this is analogous to the Unix command <code class="docutils literal notranslate"><span class="pre">su</span></code>.</p>
<p>Or, if function-to-execute is specified,
change Tarantool’s <a class="reference internal" href="../../book/box/authentication_index.html#authentication-users"><span class="std std-ref">current user</span></a>
temporarily while executing the function –
this is analogous to the Unix command <code class="docutils literal notranslate"><span class="pre">sudo</span></code>.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>user-name</strong> (<em>string</em>) – name of a target user</li>
<li><strong>function-to-execute</strong> – name of a function, or definition of a function.
Additional parameters may be passed to
<code class="docutils literal notranslate"><span class="pre">box.session.su</span></code>, they will be interpreted
as parameters of function-to-execute.</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p><strong>Example</strong></p>
<div class="highlight-tarantoolsession notranslate"><div class="highlight"><pre><span></span>tarantool&gt; function f(a) return box.session.user() .. a end
---
...

tarantool&gt; box.session.su(&#39;guest&#39;, f, &#39;-xxx&#39;)
---
- guest-xxx
...

tarantool&gt; box.session.su(&#39;guest&#39;,function(...) return ... end,1,2)
---
- 1
- 2
...
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-session-uid"></span><dl class="function">
<dt id="box.session.uid">
<code class="descclassname">box.session.</code><code class="descname">uid</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#box.session.uid" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">the user ID of the <a class="reference internal" href="../../book/box/authentication_index.html#authentication-users"><span class="std std-ref">current user</span></a>.</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body">number</td>
</tr>
</tbody>
</table>
<p>Every user has a unique name (seen with <a class="reference internal" href="#box-session-user"><span class="std std-ref">box.session.user()</span></a>)
and a unique ID (seen with <code class="docutils literal notranslate"><span class="pre">box.session.uid()</span></code>). The values are stored
together in the <code class="docutils literal notranslate"><span class="pre">_user</span></code> space.</p>
</dd></dl>

<span class="target" id="box-session-euid"></span><dl class="function">
<dt id="box.session.euid">
<code class="descclassname">box.session.</code><code class="descname">euid</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#box.session.euid" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">the effective user ID of the <a class="reference internal" href="../../book/box/authentication_index.html#authentication-users"><span class="std std-ref">current user</span></a>.</td>
</tr>
</tbody>
</table>
<p>This is the same as <a class="reference internal" href="#box-session-uid"><span class="std std-ref">box.session.uid()</span></a>, except
in two cases:</p>
<ul class="simple">
<li>The first case: if the call to <code class="docutils literal notranslate"><span class="pre">box.session.euid()</span></code> is within
a function invoked by
<a class="reference internal" href="#box-session-su"><span class="std std-ref">box.session.su(user-name, function-to-execute)</span></a>
– in that case, <code class="docutils literal notranslate"><span class="pre">box.session.euid()</span></code> returns the ID of the changed user
(the user who is specified by the <code class="docutils literal notranslate"><span class="pre">user-name</span></code> parameter of the <code class="docutils literal notranslate"><span class="pre">su</span></code>
function)  but <code class="docutils literal notranslate"><span class="pre">box.session.uid()</span></code> returns the ID of the original user
(the user who is calling the <code class="docutils literal notranslate"><span class="pre">su</span></code> function).</li>
<li>The second case: if the call to <code class="docutils literal notranslate"><span class="pre">box.session.euid()</span></code> is within
a function specified with
<a class="reference internal" href="box_schema.html#box-schema-func-create"><span class="std std-ref">box.schema.func.create(function-name, {setuid= true})</span></a>
and the binary protocol is in use
– in that case, <code class="docutils literal notranslate"><span class="pre">box.session.euid()</span></code> returns the ID of the user who
created “function-name” but <code class="docutils literal notranslate"><span class="pre">box.session.uid()</span></code> returns the ID of the
the user who is calling “function-name”.</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Return type:</th><td class="field-body">number</td>
</tr>
</tbody>
</table>
<p><strong>Example</strong></p>
<div class="highlight-tarantoolsession notranslate"><div class="highlight"><pre><span></span>tarantool&gt; box.session.su(&#39;admin&#39;)
---
...
tarantool&gt; box.session.uid(), box.session.euid()
---
- 1
- 1
...
tarantool&gt; function f() return {box.session.uid(),box.session.euid()} end
---
...
tarantool&gt; box.session.su(&#39;guest&#39;, f)
---
- - 1
  - 0
...
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-session-storage"></span><dl class="data">
<dt id="box.session.storage">
<code class="descclassname">box.session.</code><code class="descname">storage</code><a class="headerlink" href="#box.session.storage" title="Permalink to this definition">¶</a></dt>
<dd><p>A Lua table that can hold arbitrary unordered session-specific
names and values, which will last until the session ends.
For example, this table could be useful to store current tasks when working
with a <a class="reference external" href="https://github.com/tarantool/queue">Tarantool queue manager</a>.</p>
<p><strong>Example</strong></p>
<div class="highlight-tarantoolsession notranslate"><div class="highlight"><pre><span></span>tarantool&gt; box.session.peer(box.session.id())
---
- 127.0.0.1:45129
...
tarantool&gt; box.session.storage.random_memorandum = &quot;Don&#39;t forget the eggs&quot;
---
...
tarantool&gt; box.session.storage.radius_of_mars = 3396
---
...
tarantool&gt; m = &#39;&#39;
---
...
tarantool&gt; for k, v in pairs(box.session.storage) do
         &gt;   m = m .. k .. &#39;=&#39;.. v .. &#39; &#39;
         &gt; end
---
...
tarantool&gt; m
---
- &#39;radius_of_mars=3396 random_memorandum=Don&#39;t forget the eggs. &#39;
...
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-session-on-connect"></span><dl class="function">
<dt id="box.session.box.session.on_connect">
<code class="descclassname">box.session.</code><code class="descname">on_connect</code><span class="sig-paren">(</span><span class="optional">[</span><em>trigger-function</em><span class="optional">[</span>, <em>old-trigger-function</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#box.session.box.session.on_connect" title="Permalink to this definition">¶</a></dt>
<dd><p>Define a trigger for execution when a new session is created due to an event
such as <a class="reference internal" href="console.html#console-connect"><span class="std std-ref">console.connect</span></a>. The trigger function will be the first thing
executed after a new session is created. If the trigger execution fails and raises an
error, the error is sent to the client and the connection is closed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>trigger-function</strong> (<em>function</em>) – function which will become the trigger function</li>
<li><strong>old-trigger-function</strong> (<em>function</em>) – existing trigger function which will be replaced by trigger-function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">nil or function pointer</p>
</td>
</tr>
</tbody>
</table>
<p>If the parameters are (nil, old-trigger-function), then the old trigger is deleted.</p>
<p>If both parameters are omitted, then the response is a list of existing trigger functions.</p>
<p>Details about trigger characteristics are in the <a class="reference internal" href="../../book/box/triggers.html#triggers-box-triggers"><span class="std std-ref">triggers</span></a> section.</p>
<p><strong>Example</strong></p>
<div class="highlight-tarantoolsession notranslate"><div class="highlight"><pre><span></span>tarantool&gt; function f ()
         &gt;   x = x + 1
         &gt; end
tarantool&gt; box.session.on_connect(f)
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If a trigger always results in an error, it may become impossible to
connect to a server to reset it.</p>
</div>
</dd></dl>

<span class="target" id="box-session-on-disconnect"></span><dl class="function">
<dt id="box.session.box.session.on_disconnect">
<code class="descclassname">box.session.</code><code class="descname">on_disconnect</code><span class="sig-paren">(</span><span class="optional">[</span><em>trigger-function</em><span class="optional">[</span>, <em>old-trigger-function</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#box.session.box.session.on_disconnect" title="Permalink to this definition">¶</a></dt>
<dd><p>Define a trigger for execution after a client has disconnected. If the trigger
function causes an error, the error is logged but otherwise is ignored. The
trigger is invoked while the session associated with the client still exists
and can access session properties, such as <a class="reference internal" href="#box-session-id"><span class="std std-ref">box.session.id()</span></a>.</p>
<p>Since version 1.10, the trigger function is invoked immediately after the disconnect,
even if requests that were made during the session have not finished.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>trigger-function</strong> (<em>function</em>) – function which will become the trigger function</li>
<li><strong>old-trigger-function</strong> (<em>function</em>) – existing trigger function which will be replaced by trigger-function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">nil or function pointer</p>
</td>
</tr>
</tbody>
</table>
<p>If the parameters are (nil, old-trigger-function), then the old trigger is deleted.</p>
<p>If both parameters are omitted, then the response is a list of existing trigger functions.</p>
<p>Details about trigger characteristics are in the <a class="reference internal" href="../../book/box/triggers.html#triggers-box-triggers"><span class="std std-ref">triggers</span></a> section.</p>
<p><strong>Example #1</strong></p>
<div class="highlight-tarantoolsession notranslate"><div class="highlight"><pre><span></span>tarantool&gt; function f ()
         &gt;   x = x + 1
         &gt; end
tarantool&gt; box.session.on_disconnect(f)
</pre></div>
</div>
<p><strong>Example #2</strong></p>
<p>After the following series of requests, a Tarantool instance will write a message
using the <a class="reference internal" href="log.html#log-module"><span class="std std-ref">log</span></a> module whenever any user connects or disconnects.</p>
<div class="highlight-lua_tarantool notranslate"><div class="highlight"><pre><span></span>function log_connect ()
  local log = require(&#39;log&#39;)
  local m = &#39;Connection. user=&#39; .. box.session.user() .. &#39; id=&#39; .. box.session.id()
  log.info(m)
end

function log_disconnect ()
  local log = require(&#39;log&#39;)
  local m = &#39;Disconnection. user=&#39; .. box.session.user() .. &#39; id=&#39; .. box.session.id()
  log.info(m)
end

box.session.on_connect(log_connect)
box.session.on_disconnect(log_disconnect)
</pre></div>
</div>
<p>Here is what might appear in the log file in a typical installation:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">13</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mf">34.444</span> <span class="p">[</span><span class="mi">11360</span><span class="p">]</span> <span class="n">main</span><span class="o">/</span><span class="mi">103</span><span class="o">/</span><span class="n">iproto</span> <span class="n">I</span><span class="o">&gt;</span>
    <span class="n">Connection</span><span class="p">.</span> <span class="n">user</span><span class="o">=</span><span class="n">guest</span> <span class="n">id</span><span class="o">=</span><span class="mi">3</span>
<span class="mi">2014</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">15</span> <span class="mi">13</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mf">19.289</span> <span class="p">[</span><span class="mi">11360</span><span class="p">]</span> <span class="n">main</span><span class="o">/</span><span class="mi">103</span><span class="o">/</span><span class="n">iproto</span> <span class="n">I</span><span class="o">&gt;</span>
    <span class="n">Disconnection</span><span class="p">.</span> <span class="n">user</span><span class="o">=</span><span class="n">guest</span> <span class="n">id</span><span class="o">=</span><span class="mi">3</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-session-on-auth"></span><dl class="function">
<dt id="box.session.box.session.on_auth">
<code class="descclassname">box.session.</code><code class="descname">on_auth</code><span class="sig-paren">(</span><span class="optional">[</span><em>trigger-function</em><span class="optional">[</span>, <em>old-trigger-function</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#box.session.box.session.on_auth" title="Permalink to this definition">¶</a></dt>
<dd><p>Define a trigger for execution during <a class="reference internal" href="../../book/box/authentication_index.html#authentication-users"><span class="std std-ref">authentication</span></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">on_auth</span></code> trigger function is invoked in these circumstances:</p>
<ol class="arabic simple">
<li>The <a class="reference internal" href="console.html#console-connect"><span class="std std-ref">console.connect</span></a> function includes an authentication check
for all users except ‘guest’.
For this case, the <code class="docutils literal notranslate"><span class="pre">on_auth</span></code> trigger function is invoked after the <code class="docutils literal notranslate"><span class="pre">on_connect</span></code>
trigger function, if and only if the connection has succeeded so far.</li>
<li>The <a class="reference internal" href="../../book/admin/security.html#admin-security"><span class="std std-ref">binary protocol</span></a> has a separate
<a class="reference internal" href="../../dev_guide/internals_index.html#box-protocol-authentication"><span class="std std-ref">authentication packet</span></a>.
For this case, connection and authentication are considered to be separate steps.</li>
</ol>
<p>Unlike other trigger types, <code class="docutils literal notranslate"><span class="pre">on_auth</span></code> trigger functions are invoked <strong>before</strong>
the event. Therefore a trigger function like <code class="code docutils literal notranslate"><span class="pre">function</span> <span class="pre">auth_function</span> <span class="pre">()</span> <span class="pre">v</span> <span class="pre">=</span> <span class="pre">box.session.user();</span> <span class="pre">end</span></code>
will set <code class="code docutils literal notranslate"><span class="pre">v</span></code> to “guest”, the user name before the authentication is done.
To get the user name <strong>after</strong> the authentication is done, use the special syntax:
<code class="code docutils literal notranslate"><span class="pre">function</span> <span class="pre">auth_function</span> <span class="pre">(user_name)</span> <span class="pre">v</span> <span class="pre">=</span> <span class="pre">user_name;</span> <span class="pre">end</span></code></p>
<p>If the trigger fails by raising an error, the error is sent to the client and the connection is closed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>trigger-function</strong> (<em>function</em>) – function which will become the trigger function</li>
<li><strong>old-trigger-function</strong> (<em>function</em>) – existing trigger function which will be replaced by trigger-function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">nil or function pointer</p>
</td>
</tr>
</tbody>
</table>
<p>If the parameters are (nil, old-trigger-function), then the old trigger is deleted.</p>
<p>If both parameters are omitted, then the response is a list of existing trigger functions.</p>
<p>Details about trigger characteristics are in the <a class="reference internal" href="../../book/box/triggers.html#triggers-box-triggers"><span class="std std-ref">triggers</span></a> section.</p>
<p><strong>Example 1</strong></p>
<div class="highlight-tarantoolsession notranslate"><div class="highlight"><pre><span></span>tarantool&gt; function f ()
         &gt;   x = x + 1
         &gt; end
tarantool&gt; box.session.on_auth(f)
</pre></div>
</div>
<p><strong>Example 2</strong></p>
<p>This is a more complex example, with two server instances.</p>
<p>The first server instance listens on port 3301; its default
user name is ‘admin’.
There are three <code class="docutils literal notranslate"><span class="pre">on_auth</span></code> triggers:</p>
<ul class="simple">
<li>The first trigger has a function with no arguments, it can only look
at <code class="docutils literal notranslate"><span class="pre">box.session.user()</span></code>.</li>
<li>The second trigger has a function with a <code class="docutils literal notranslate"><span class="pre">user_name</span></code> argument,
it can look at both of: <code class="docutils literal notranslate"><span class="pre">box.session.user()</span></code> and <code class="docutils literal notranslate"><span class="pre">user_name</span></code>.</li>
<li>The third trigger has a function with a <code class="docutils literal notranslate"><span class="pre">user_name</span></code> argument
and a <code class="docutils literal notranslate"><span class="pre">status</span></code> argument,
it can look at all three of:
<code class="docutils literal notranslate"><span class="pre">box.session.user()</span></code> and <code class="docutils literal notranslate"><span class="pre">user_name</span></code> and <code class="docutils literal notranslate"><span class="pre">status</span></code>.</li>
</ul>
<p>The second server instance will connect with
<a class="reference internal" href="console.html#console-connect"><span class="std std-ref">console.connect</span></a>,
and then will cause a display of the variables that were set by the
trigger functions.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">-- On the first server instance, which listens on port 3301</span>
<span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span><span class="o">=</span><span class="mi">3301</span><span class="p">}</span>
<span class="kr">function</span> <span class="nf">function1</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;function 1, box.session.user()=&#39;</span><span class="o">..</span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">user</span><span class="p">())</span>
  <span class="kr">end</span>
<span class="kr">function</span> <span class="nf">function2</span><span class="p">(</span><span class="n">user_name</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;function 2, box.session.user()=&#39;</span><span class="o">..</span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">user</span><span class="p">())</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;function 2, user_name=&#39;</span><span class="o">..</span><span class="n">user_name</span><span class="p">)</span>
  <span class="kr">end</span>
<span class="kr">function</span> <span class="nf">function3</span><span class="p">(</span><span class="n">user_name</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;function 3, box.session.user()=&#39;</span><span class="o">..</span><span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">user</span><span class="p">())</span>
  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;function 3, user_name=&#39;</span><span class="o">..</span><span class="n">user_name</span><span class="p">)</span>
  <span class="kr">if</span> <span class="n">status</span> <span class="o">==</span> <span class="kc">true</span> <span class="kr">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;function 3, status = true, authorization succeeded&#39;</span><span class="p">)</span>
    <span class="kr">end</span>
  <span class="kr">end</span>
<span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_auth</span><span class="p">(</span><span class="n">function1</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_auth</span><span class="p">(</span><span class="n">function2</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">on_auth</span><span class="p">(</span><span class="n">function3</span><span class="p">)</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">passwd</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">-- On the second server instance, that connects to port 3301</span>
<span class="n">console</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;console&#39;</span><span class="p">)</span>
<span class="n">console</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;admin:admin@localhost:3301&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The result looks like this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">function 3, box.session.user()=guest</span>
<span class="go">function 3, user_name=admin</span>
<span class="go">function 3, status = true, authorization succeeded</span>
<span class="go">function 2, box.session.user()=guest</span>
<span class="go">function 2, user_name=admin</span>
<span class="go">function 1, box.session.user()=guest</span>
</pre></div>
</div>
</dd></dl>

<span class="target" id="box-session-on-access-denied"></span><dl class="function">
<dt id="box.session.box.session.on_access_denied">
<code class="descclassname">box.session.</code><code class="descname">on_access_denied</code><span class="sig-paren">(</span><span class="optional">[</span><em>trigger-function</em><span class="optional">[</span>, <em>old-trigger-function</em><span class="optional">]</span><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#box.session.box.session.on_access_denied" title="Permalink to this definition">¶</a></dt>
<dd><p>Define a trigger for reacting to user’s attempts to execute actions that are
not within the user’s privileges.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>trigger-function</strong> (<em>function</em>) – function which will become the trigger function</li>
<li><strong>old-trigger-function</strong> (<em>function</em>) – existing trigger function which will be
replaced by trigger-function</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">nil or function pointer</p>
</td>
</tr>
</tbody>
</table>
<p>If the parameters are <cite>(nil, old-trigger-function)</cite>, then the old trigger is deleted.</p>
<p>If both parameters are omitted, then the response is a list of existing trigger functions.</p>
<p>Details about trigger characteristics are in the <a class="reference internal" href="../../book/box/triggers.html#triggers-box-triggers"><span class="std std-ref">triggers</span></a> section.</p>
<p><strong>Example</strong></p>
<p>For example, server administrator can log restricted actions like this:</p>
<div class="highlight-tarantoolsession notranslate"><div class="highlight"><pre><span></span>tarantool&gt; function on_access_denied(op, type, name)
         &gt; log.warn(&#39;User %s tried to %s %s %s without required privileges&#39;, box.session.user(), op, type, name)
         &gt; end
---
...
tarantool&gt; box.session.on_access_denied(on_access_denied)
---
- &#39;function: 0x011b41af38&#39;
...
tarantool&gt; function test() print(&#39;you shall not pass&#39;) end
---
...
tarantool&gt; box.schema.func.create(&#39;test&#39;)
---
...
</pre></div>
</div>
<p>Then, when some user without required privileges tries to call <code class="docutils literal notranslate"><span class="pre">test()</span></code>
and gets the error, the server will execute this trigger and write to log
<strong>“User *user_name* tried to Execute function test without required privileges”</strong></p>
</dd></dl>

<span class="target" id="box-session-push"></span><dl class="function">
<dt id="box.session.box.session.push">
<code class="descclassname">box.session.</code><code class="descname">push</code><span class="sig-paren">(</span><em>message</em><span class="optional">[</span>, <em>sync</em><span class="optional">]</span><span class="sig-paren">)</span><a class="headerlink" href="#box.session.box.session.push" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate an out-of-band message. By “out-of-band” we mean an extra
message which supplements what is passed in a network via the usual
channels. Although <code class="docutils literal notranslate"><span class="pre">box.session.push()</span></code> can be called at any time, in
practice it is used with networks that are set up with
<a class="reference internal" href="net_box.html#net-box-module"><span class="std std-ref">module net.box</span></a>, and
it is invoked by the server (on the “remote database system” to use
our terminology for net.box), and the client has options for getting
such messages.</p>
<p>This function returns an error if the session is disconnected.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>message</strong> (<em>any-Lua-type</em>) – what to send</li>
<li><strong>sync</strong> (<em>int</em>) – an optional argument to indicate what the session is,
as taken from an earlier call to <a class="reference internal" href="#box-session-sync"><span class="std std-ref">box_session:sync()</span></a>.
If it is omitted, the default is the current <code class="docutils literal notranslate"><span class="pre">box.session.sync()</span></code> value.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Return type:</th><td class="field-body"><p class="first last"><p>{nil, error} or true:</p>
<ul class="simple">
<li>If the result is an error, then the first part of the return is
<code class="docutils literal notranslate"><span class="pre">nil</span></code> and the second part is the error object.</li>
<li>If the result is not an error, then the return is the boolean value <code class="docutils literal notranslate"><span class="pre">true</span></code>.</li>
<li>When the return is <code class="docutils literal notranslate"><span class="pre">true</span></code>, the message has gone to the network
buffer as a <a class="reference internal" href="../../dev_guide/internals_index.html#box-protocol-iproto-protocol"><span class="std std-ref">packet</span></a>
with the code IPROTO_CHUNK (0x80).</li>
</ul>
</p>
</td>
</tr>
</tbody>
</table>
<p>The server’s sole job is to call <code class="docutils literal notranslate"><span class="pre">box.session.push()</span></code>, there is no
automatic mechanism for showing that the message was received.</p>
<p>The client’s job is to check for such messages after it sends
something to the server. The major client methods –
<a class="reference internal" href="net_box.html#net-box-call"><span class="std std-ref">conn:call</span></a>, <a class="reference internal" href="net_box.html#net-box-eval"><span class="std std-ref">conn:eval</span></a>,
<a class="reference internal" href="net_box.html#conn-select"><span class="std std-ref">conn:select</span></a>, <a class="reference internal" href="net_box.html#conn-insert"><span class="std std-ref">conn:insert</span></a>,
<a class="reference internal" href="net_box.html#conn-replace"><span class="std std-ref">conn:replace</span></a>, <a class="reference internal" href="net_box.html#conn-update"><span class="std std-ref">conn:update</span></a>,
<a class="reference internal" href="net_box.html#conn-upsert"><span class="std std-ref">conn:upsert</span></a>, <a class="reference internal" href="net_box.html#conn-delete"><span class="std std-ref">delete</span></a> –
may cause the server to send a message.</p>
<p>Situation 1: when the client calls synchronously with the default
<code class="docutils literal notranslate"><span class="pre">{async=false}</span></code> option. There are two optional additional options:
<code class="samp docutils literal notranslate"><span class="pre">on_push=</span><em><span class="pre">function-name</span></em></code>, and <code class="samp docutils literal notranslate"><span class="pre">on_push_ctx=</span><em><span class="pre">function-argument</span></em></code>.
When the client receives an out-of-band message for the session,
it invokes “function-name(function-argument)”. For example, with
options <code class="docutils literal notranslate"><span class="pre">{on_push=table.insert,</span> <span class="pre">on_push_ctx=messages}</span></code>, the client
will insert whatever it receives into a table named ‘messages’.</p>
<p>Situation 2: when the client calls asynchronously with the non-default
<code class="docutils literal notranslate"><span class="pre">{async=true}</span></code> option. Here <code class="docutils literal notranslate"><span class="pre">on_push</span></code> and <code class="docutils literal notranslate"><span class="pre">on_push_ctx</span></code> are not allowed, but
the messages can be seen by calling <code class="docutils literal notranslate"><span class="pre">pairs()</span></code> in a loop.</p>
<p>Situation 2 complication: <code class="docutils literal notranslate"><span class="pre">pairs()</span></code> is subject to timeout. So there
is an optional argument = timeout per iteration. If timeout occurs before
there is a new message or a final response, there is an error return.
To check for an error one can use the first loop parameter (if the loop
starts with “for i, message in future:pairs()” then the first loop parameter
is i). If it is <code class="docutils literal notranslate"><span class="pre">box.NULL</span></code> then the second parameter (in our example, “message”)
is the error object.</p>
<p><strong>Example</strong></p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Make two shells. On Shell#1 set up a &quot;server&quot;, and</span>
<span class="c1">-- in it have a function that includes box.session.push:</span>
<span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{</span><span class="n">listen</span><span class="o">=</span><span class="mi">3301</span><span class="p">}</span>
<span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">grant</span><span class="p">(</span><span class="s1">&#39;guest&#39;</span><span class="p">,</span><span class="s1">&#39;read,write,execute&#39;</span><span class="p">,</span><span class="s1">&#39;universe&#39;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">fiber</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;fiber&#39;</span><span class="p">)</span>
<span class="kr">function</span> <span class="nf">server_function</span><span class="p">()</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">fiber</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="n">box</span><span class="p">.</span><span class="n">session</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="kr">end</span>

<span class="c1">-- On Shell#2 connect to this server as a &quot;client&quot; that</span>
<span class="c1">-- can handle Lua (such as another Tarantool server operating</span>
<span class="c1">-- as a client), and initialize a table where we&#39;ll get messages:</span>
<span class="n">net_box</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;net.box&#39;</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">net_box</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="mi">3301</span><span class="p">)</span>
<span class="n">messages_from_server</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">-- On Shell#2 remotely call the server function and receive</span>
<span class="c1">-- a SYNCHRONOUS out-of-band message:</span>
<span class="n">conn</span><span class="p">:</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;server_function&#39;</span><span class="p">,</span> <span class="p">{},</span>
          <span class="p">{</span><span class="n">is_async</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
           <span class="n">on_push</span> <span class="o">=</span> <span class="nb">table.insert</span><span class="p">,</span>
           <span class="n">on_push_ctx</span> <span class="o">=</span> <span class="n">messages_from_server</span><span class="p">})</span>
<span class="n">messages_from_server</span>
<span class="c1">-- After a 1-second pause that is caused by the fiber.sleep()</span>
<span class="c1">-- request inside server_function, the result in the</span>
<span class="c1">--  messages_from_server table will be: 1. Like this:</span>
<span class="c1">-- tarantool&gt; messages_from_server</span>
<span class="c1">-- ---</span>
<span class="c1">-- - - 1</span>
<span class="c1">-- ...</span>
<span class="c1">-- Good. That shows that box.session.push(x) worked,</span>
<span class="c1">-- because we know that x was 1.</span>

<span class="c1">-- On Shell#2 remotely call the same server function and</span>
<span class="c1">-- get an ASYNCHRONOUS out-of-band message. For this we cannot</span>
<span class="c1">-- use on_push and on_push_ctx options, but we can use pairs():</span>
<span class="n">future</span> <span class="o">=</span> <span class="n">conn</span><span class="p">:</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;server_function&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="n">is_async</span> <span class="o">=</span> <span class="kc">true</span><span class="p">})</span>
<span class="n">messages</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">keys</span> <span class="o">=</span> <span class="p">{}</span>
<span class="kr">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">message</span> <span class="kr">in</span> <span class="n">future</span><span class="p">:</span><span class="nb">pairs</span><span class="p">()</span> <span class="kr">do</span>
    <span class="nb">table.insert</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="nb">table.insert</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="kr">end</span>
<span class="n">messages</span>
<span class="n">future</span><span class="p">:</span><span class="n">wait_result</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="kr">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">message</span> <span class="kr">in</span> <span class="n">future</span><span class="p">:</span><span class="nb">pairs</span><span class="p">()</span> <span class="kr">do</span>
    <span class="nb">table.insert</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span> <span class="nb">table.insert</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="kr">end</span>
<span class="n">messages</span>
<span class="c1">-- There is no pause because conn:call does not wait for</span>
<span class="c1">-- server_function to finish. The first time that we go through</span>
<span class="c1">-- the pairs() loop, we see the messages table is empty. Like this:</span>
<span class="c1">-- tarantool&gt; messages</span>
<span class="c1">-- ---</span>
<span class="c1">-- - - 2</span>
<span class="c1">--   - []</span>
<span class="c1">-- ...</span>
<span class="c1">-- That is okay because the server hasn&#39;t yet called</span>
<span class="c1">-- box.session.push(). The second time that we go through</span>
<span class="c1">-- the pairs() loop, we see the value of x at the time of</span>
<span class="c1">-- the second call to box.session.push(). Like this:</span>
<span class="c1">-- tarantool&gt; messages</span>
<span class="c1">-- ---</span>
<span class="c1">-- - - 2</span>
<span class="c1">--   - &amp;0 []</span>
<span class="c1">--   - 2</span>
<span class="c1">--   - *0</span>
<span class="c1">-- ...</span>
<span class="c1">-- Good. That shows that the message was asynchronous, and</span>
<span class="c1">-- that box.session.push() did its job.</span>
</pre></div>
</div>
</dd></dl>

</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Tarantool Core Team

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>